<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>èµ¤å­—ãƒ©ã‚¤ãƒ³ï¼‹éå»æœ€ä½ãƒ©ã‚¤ãƒ³ï¼ˆç´«ï¼‰</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<style>
  body{
    margin:0;
    background:#f3f4f6;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    color:#111827;
  }
  .wrapper{
    max-width:1100px;
    margin:24px auto;
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 28px rgba(0,0,0,.08);
    padding:16px 18px 18px;
  }
  h1{ font-size:15px; margin:0 0 8px; font-weight:700; }
  .controls{
    display:flex; flex-wrap:wrap; align-items:center; gap:12px;
    margin: 8px 0 8px;
  }
  .controls label{ font-size:12px; color:#374151; }
  .controls input[type="number"]{
    width:80px; padding:4px 6px; border:1px solid #d1d5db; border-radius:6px; font-size:12px;
  }
  .chartBox{ height:320px; position:relative; }
  canvas{ width:100% !important; height:100% !important; display:block; }
  .note{ font-size:12px; color:#6b7280; margin-top:10px; line-height:1.45; }
</style>
</head>
<body>
<div class="wrapper">
  <h1>ãƒ©ãƒ³ã‚­ãƒ³ã‚° / ã‚»ãƒ©ãƒ¼æ•° / ä¾¡æ ¼ + èµ¤å­—ãƒ©ã‚¤ãƒ³ & éå»æœ€ä½ãƒ©ã‚¤ãƒ³</h1>

  <div class="controls">
    <label>èµ¤å­—ãƒ©ã‚¤ãƒ³ï¼ˆUSDï¼‰</label>
    <input id="lossInput" type="number" step="0.1" value="5.7">
    <label style="display:flex;align-items:center;gap:6px;">
      <input id="lossToggle" type="checkbox" checked>
      èµ¤å­—ãƒ©ã‚¤ãƒ³è¡¨ç¤º
    </label>
  </div>

  <div class="chartBox"><canvas id="chart"></canvas></div>

  <div class="note">
    ğŸŸ  èµ¤å­—ãƒ©ã‚¤ãƒ³ï¼šã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆå…¥åŠ›ï¼‹ON/OFFï¼‰<br>
    ğŸŸ£ éå»æœ€ä½ãƒ©ã‚¤ãƒ³ï¼šç´«ï¼ˆä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®æœ€å°å€¤ã‚’åŸºæº–ã«ã€èƒŒæ™¯ã®ã¿ã§å¼·èª¿ï¼‰
  </div>
</div>

<script>
Chart.register(window['chartjs-plugin-annotation']);

// ===== ãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒå¯„ã›ï¼‰ =====
const N = 180;
const labels = Array.from({length:N}, (_,i)=> `${N-i}æ—¥`);
let seed = 42;
function rand(){ seed = (seed * 1664525 + 1013904223) % 4294967296; return seed / 4294967296; }
function noise(scale){ return (rand()-0.5) * scale; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// ä¾¡æ ¼
const price = [];
for(let i=0;i<N;i++){
  let v;
  if(i < 15)       v = 12 - (i/15)*1.8;
  else if(i < 60)  v = 10.2 - ((i-15)/45)*0.8;
  else if(i < 110) v = 9.4 - ((i-60)/50)*0.4;
  else if(i < 140) v = 9.0 + ((i-110)/30)*0.4;
  else if(i < 155) v = 9.4 - ((i-140)/15)*0.7;
  else if(i < 165) v = 8.7 - ((i-155)/10)*2.5;
  else             v = 6.2 + ((i-165)/15)*0.4;
  v = clamp(v + noise(0.14), 5.6, 12.2);
  v = Math.round(v * 10) / 10;
  price.push(v);
}

// ã‚»ãƒ©ãƒ¼æ•°
const sellers = [];
for(let i=0;i<N;i++){
  let v = 7;
  if(i < 70) v = 7;
  else if(i < 95) v = 6;
  else if(i < 120) v = 8;
  else if(i < 150) v = 7;
  else if(i < 160) v = 8;
  else if(i < 172) v = 12;
  else v = 11;
  sellers.push(v);
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°
const rank = [];
let r = 55500;
for(let i=0;i<N;i++){
  r += noise(700);
  if(i === 92 || i === 118) r += 6500;
  if(i === 100) r -= 4500;
  r = clamp(r, 49000, 67000);
  rank.push(Math.round(r));
}

// ===== ãƒ©ã‚¤ãƒ³å€¤ =====
let LOSS_LINE = 5.7;
const MIN_LINE = Math.min(...price); // éå»æœ€ä½ä¾¡æ ¼

// ===== è‰² =====
const ORANGE = '#f59e0b';
const ORANGE_FILL = 'rgba(245,158,11,.12)';
const PURPLE = '#8b5cf6';
const PURPLE_FILL = 'rgba(139,92,246,.12)';

// ===== èƒŒæ™¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆèµ¤å­—ãƒ©ã‚¤ãƒ³ï¼‰ =====
const lossBgPlugin = {
  id:'lossBg',
  beforeDatasetsDraw(chart,args,opts){
    if(opts && opts.enabled === false) return;
    const {ctx,chartArea,scales}=chart;
    if(!chartArea) return;
    const y = scales.yPrice.getPixelForValue(opts.loss);
    ctx.save();
    ctx.fillStyle = ORANGE_FILL;
    ctx.fillRect(chartArea.left, y, chartArea.right-chartArea.left, chartArea.bottom-y);
    ctx.restore();
  }
};

// ===== èƒŒæ™¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆéå»æœ€ä½ãƒ©ã‚¤ãƒ³ãƒ»ç´«ï¼‰ =====
const minBgPlugin = {
  id:'minBg',
  beforeDatasetsDraw(chart,args,opts){
    const {ctx,chartArea,scales}=chart;
    if(!chartArea) return;
    const y = scales.yPrice.getPixelForValue(opts.min);
    ctx.save();
    ctx.fillStyle = PURPLE_FILL;
    ctx.fillRect(chartArea.left, y, chartArea.right-chartArea.left, chartArea.bottom-y);
    ctx.restore();
  }
};

Chart.register(lossBgPlugin, minBgPlugin);

// ===== ãƒãƒ£ãƒ¼ãƒˆ =====
const chart = new Chart(document.getElementById('chart'),{
  type:'line',
  data:{
    labels,
    datasets:[
      { label:'ãƒ©ãƒ³ã‚­ãƒ³ã‚°', data:rank, yAxisID:'yRank', borderColor:'#3b82f6', borderWidth:2, pointRadius:0 },
      { label:'ã‚»ãƒ©ãƒ¼æ•°', data:sellers, yAxisID:'ySeller', borderColor:'#fb7185', borderWidth:2, pointRadius:0 },
      { label:'ä¾¡æ ¼(USD)', data:price, yAxisID:'yPrice', borderColor:ORANGE, borderWidth:2, pointRadius:0 }
    ]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{display:true},
      lossBg:{ enabled:true, loss:LOSS_LINE },
      minBg:{ min:MIN_LINE },
      annotation:{
        annotations:{
          loss:{
            type:'line',
            yMin:LOSS_LINE,
            yMax:LOSS_LINE,
            yScaleID:'yPrice',
            borderColor: ORANGE,
            borderDash:[6,6],
            borderWidth:1.5,
            label:{ display:true, content:'èµ¤å­—ãƒ©ã‚¤ãƒ³', position:'end' }
          },
          min:{
            type:'line',
            yMin:MIN_LINE,
            yMax:MIN_LINE,
            yScaleID:'yPrice',
            borderColor: PURPLE,
            borderDash:[4,6],
            borderWidth:1,
            label:{ display:true, content:'éå»æœ€ä½', position:'end', color:PURPLE }
          }
        }
      }
    },
    scales:{
      yRank:{ position:'left', suggestedMin:48000, suggestedMax:68000 },
      ySeller:{ position:'right', grid:{drawOnChartArea:false}, suggestedMin:5, suggestedMax:12 },
      yPrice:{ position:'right', offset:true, grid:{drawOnChartArea:false}, suggestedMin:4.8, suggestedMax:12.5 }
    }
  }
});

// ===== UI =====
const lossInput = document.getElementById('lossInput');
const lossToggle = document.getElementById('lossToggle');

lossInput.addEventListener('input', ()=>{
  const v = parseFloat(lossInput.value);
  if(isNaN(v)) return;
  LOSS_LINE = v;
  chart.options.plugins.lossBg.loss = v;
  chart.options.plugins.annotation.annotations.loss.yMin = v;
  chart.options.plugins.annotation.annotations.loss.yMax = v;
  chart.update();
});

lossToggle.addEventListener('change', ()=>{
  const show = lossToggle.checked;
  chart.options.plugins.lossBg.enabled = show;
  chart.options.plugins.annotation.annotations.loss.display = show;
  chart.update();
});
</script>
</body>
</html>
